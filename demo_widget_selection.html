<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Selection Modal Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Widget Selection Modal Demo</h1>
        
        <div class="bg-white rounded-lg p-4 mb-4">
            <p class="text-gray-700 mb-4">
                This demo shows the complete widget lifecycle: automatic creation, manual selection, and persistent save/load functionality.
            </p>
            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                <p class="text-blue-800 text-sm">
                    <strong>Default Widgets:</strong> On NEW pages, default widgets auto-create as real widgets! After saving, they won't auto-create anymore.
                </p>
            </div>
            <div class="bg-green-50 border border-green-200 rounded p-3 mb-3">
                <p class="text-green-800 text-sm">
                    <strong>Widget Selection:</strong> Click ••• on any slot → "Add Widget" → Search, browse by category, click to select!
                </p>
            </div>
            <div class="bg-purple-50 border border-purple-200 rounded p-3 mb-3">
                <p class="text-purple-800 text-sm">
                    <strong>Save/Load:</strong> "Save Page" captures all widget data. "Load Saved Page" restores it exactly as saved. Saved widgets always override defaults!
                </p>
            </div>
            <div class="bg-orange-50 border border-orange-200 rounded p-3">
                <p class="text-orange-800 text-sm">
                    <strong>Auto-Save:</strong> Page automatically saves 2 seconds after any change (add/delete/edit widgets). Watch the status indicators!
                </p>
            </div>
        </div>

        <div class="bg-white rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-3">Demo Layout with Slots</h2>
            <div id="layout-container" class="border border-gray-300 rounded p-4 min-h-64 bg-gray-50">
                <!-- Layout will be rendered here -->
            </div>
        </div>

        <div class="mt-4 space-x-4">
            <button id="render-layout" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Render Layout
            </button>
            <button id="count-widgets" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                Count Widgets
            </button>
            <button id="clear-all-widgets" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                Clear All Widgets
            </button>
        </div>
        
        <div class="mt-4 space-x-4">
            <button id="save-page" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                Save Page
            </button>
            <button id="load-page" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                Load Saved Page
            </button>
            <button id="reset-page" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                Reset to New Page
            </button>
            <button id="toggle-autosave" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">
                Disable Auto-Save
            </button>
        </div>
        
        <div class="mt-4 flex items-center space-x-4">
            <span id="page-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm"></span>
            <span id="dirty-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hidden"></span>
            <span id="autosave-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hidden"></span>
        </div>

        <div id="widget-summary" class="mt-4 bg-white rounded-lg p-4 hidden">
            <h3 class="text-lg font-semibold mb-2">Widget Summary</h3>
            <div id="widget-count-display" class="text-gray-700"></div>
        </div>

        <div id="saved-data-display" class="mt-4 bg-white rounded-lg p-4 hidden">
            <h3 class="text-lg font-semibold mb-2">Saved Widget Data</h3>
            <button id="toggle-saved-data" class="text-sm text-blue-600 hover:text-blue-800 mb-2">Show Details</button>
            <div id="saved-data-content" class="hidden">
                <pre id="saved-data-json" class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-64"></pre>
            </div>
        </div>
    </div>

    <script type="module">
        import LayoutRenderer from './frontend/src/components/LayoutRenderer.js';

        // Create renderer instance
        const renderer = new LayoutRenderer();
        const targetRef = { current: document.getElementById('layout-container') };
        
        // Set up callbacks
        renderer.setUICallbacks({
            onWidgetSelected: (slotName, widgetInstance, widgetDef) => {
                console.log(`Widget selected for slot "${slotName}":`, widgetInstance);
                
                // Show success message
                showSuccessMessage(`${widgetDef.name} added to ${slotName}!`);
                
                // Widget is automatically rendered by LayoutRenderer
            },
            onWidgetAutoCreated: (slotName, widgetInstance, widgetDef) => {
                console.log(`Auto-created widget "${widgetInstance.name}" in slot "${slotName}":`, widgetInstance);
                
                // Show notification for auto-created widgets
                showSuccessMessage(`Auto-created: ${widgetInstance.name} in ${slotName}`);
            },
            onSavePageData: (widgetData) => {
                console.log('Saving page widget data:', widgetData);
                
                // Save to localStorage (simulating API persistence)
                localStorage.setItem('demo-page-widgets', JSON.stringify(widgetData));
                
                // Update display
                updateSavedDataDisplay(widgetData);
            },
            onDirtyStateChanged: (isDirty, reason) => {
                console.log(`Page dirty state changed: ${isDirty} (${reason})`);
                updateDirtyStatus(isDirty, reason);
            },
            onAutoSave: (widgetData) => {
                console.log('Auto-save completed:', widgetData);
                showAutoSaveStatus('Auto-saved successfully!', 'success');
                
                // Save to localStorage in auto-save as well
                localStorage.setItem('demo-page-widgets', JSON.stringify(widgetData));
                updateSavedDataDisplay(widgetData);
            },
            onAutoSaveError: (error) => {
                console.error('Auto-save failed:', error);
                showAutoSaveStatus('Auto-save failed!', 'error');
            },
            onEditWidget: (widgetId, widgetInstance) => {
                alert(`Edit widget "${widgetInstance.name}" (${widgetId})\n\nThis would open a widget configuration dialog.`);
                console.log('Edit widget:', widgetInstance);
                
                // Mark widget as edited (this will trigger auto-save)
                renderer.markWidgetAsEdited(widgetId, widgetInstance);
            },
            onSlotInfo: (slotName) => {
                const config = renderer.getSlotConfig(slotName);
                const slotElement = document.querySelector(`[data-slot-name="${slotName}"]`);
                const widgetCount = slotElement ? slotElement.querySelectorAll('.rendered-widget').length : 0;
                alert(`Slot Info:\nName: ${slotName}\nTitle: ${config?.title || 'N/A'}\nDescription: ${config?.description || 'N/A'}\nWidgets: ${widgetCount}`);
            },
            onClearSlot: (slotName) => {
                if (confirm(`Clear all widgets from slot "${slotName}"?`)) {
                    // Clear all widgets from the slot
                    const slotElement = document.querySelector(`[data-slot-name="${slotName}"]`);
                    if (slotElement) {
                        const widgets = slotElement.querySelectorAll('.rendered-widget');
                        widgets.forEach(widget => widget.remove());
                        
                        // Add placeholder back
                        const slotConfig = renderer.getSlotConfig(slotName);
                        const placeholder = document.createElement('div');
                        placeholder.className = 'slot-placeholder p-4 border-2 border-dashed border-gray-300 rounded text-center text-gray-500';
                        placeholder.innerHTML = `
                            <div class="text-sm font-medium">${slotConfig?.title || slotName}</div>
                            ${slotConfig?.description ? `<div class="text-xs mt-1">${slotConfig.description}</div>` : ''}
                            <div class="text-xs mt-2 opacity-75">Click ••• to add widgets</div>
                        `;
                        slotElement.appendChild(placeholder);
                    }
                    showSuccessMessage(`Cleared slot: ${slotName}`);
                }
            },
            onAddNewSlot: (slotData, slotNode, insertionContext) => {
                alert(`New slot "${slotData.name}" would be added!\nCheck console for details.`);
                console.log('New slot data:', slotData);
            }
        });

        // Demo layout
        const demoLayout = {
            structure: {
                type: 'element',
                tag: 'div',
                classes: 'demo-layout space-y-4',
                children: [
                    {
                        type: 'element',
                        tag: 'div',
                        classes: 'grid grid-cols-2 gap-4',
                        children: [
                            {
                                type: 'slot',
                                tag: 'div',
                                classes: 'bg-blue-50 border-2 border-blue-200 rounded-lg p-4 min-h-32',
                                slot: {
                                    name: 'hero-section',
                                    title: 'Hero Section',
                                    description: 'Main banner or hero content area',
                                    defaultWidgets: [
                                        {
                                            type: 'text',
                                            name: 'Welcome Message',
                                            config: {
                                                content: 'Welcome to our amazing website!',
                                                fontSize: 'large',
                                                alignment: 'center'
                                            }
                                        },
                                        {
                                            type: 'button',
                                            name: 'CTA Button',
                                            config: {
                                                text: 'Get Started',
                                                style: 'primary',
                                                size: 'large'
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                type: 'slot',
                                tag: 'div',
                                classes: 'bg-green-50 border-2 border-green-200 rounded-lg p-4 min-h-32',
                                slot: {
                                    name: 'feature-highlight',
                                    title: 'Feature Highlight',
                                    description: 'Showcase key features or announcements'
                                }
                            }
                        ]
                    },
                    {
                        type: 'slot',
                        tag: 'div',
                        classes: 'bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 min-h-24',
                                                        slot: {
                                    name: 'content-area',
                                    title: 'Main Content',
                                    description: 'Primary content and articles',
                                    defaultWidgets: [
                                        {
                                            type: 'card',
                                            name: 'Featured Article',
                                            config: {
                                                title: 'Getting Started Guide',
                                                content: 'Learn how to use our platform with this comprehensive guide that covers all the basics.',
                                                showButton: true
                                            }
                                        }
                                    ]
                                }
                    },
                    {
                        type: 'element',
                        tag: 'div',
                        classes: 'grid grid-cols-3 gap-4',
                        children: [
                            {
                                type: 'slot',
                                tag: 'div',
                                classes: 'bg-purple-50 border-2 border-purple-200 rounded-lg p-4 min-h-24',
                                slot: {
                                    name: 'sidebar-left',
                                    title: 'Left Sidebar',
                                    description: 'Navigation and quick links'
                                }
                            },
                            {
                                type: 'slot',
                                tag: 'div',
                                classes: 'bg-gray-50 border-2 border-gray-200 rounded-lg p-4 min-h-24',
                                slot: {
                                    name: 'main-column',
                                    title: 'Main Column',
                                    description: 'Central content area'
                                }
                            },
                            {
                                type: 'slot',
                                tag: 'div',
                                classes: 'bg-pink-50 border-2 border-pink-200 rounded-lg p-4 min-h-24',
                                slot: {
                                    name: 'sidebar-right',
                                    title: 'Right Sidebar',
                                    description: 'Related content and widgets'
                                }
                            }
                        ]
                    }
                ]
            }
        };

        // Helper functions
        function showSuccessMessage(message) {
            // Create temporary success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function countWidgetsInSlots() {
            const slots = document.querySelectorAll('[data-slot-name]');
            const summary = {};
            let totalWidgets = 0;

            slots.forEach(slot => {
                const slotName = slot.getAttribute('data-slot-name');
                const widgets = slot.querySelectorAll('.rendered-widget');
                summary[slotName] = widgets.length;
                totalWidgets += widgets.length;
            });

            return { summary, totalWidgets };
        }

        function updateWidgetSummary() {
            const { summary, totalWidgets } = countWidgetsInSlots();
            const display = document.getElementById('widget-summary');
            const countDisplay = document.getElementById('widget-count-display');
            
            if (totalWidgets > 0) {
                let summaryText = `<strong>Total Widgets: ${totalWidgets}</strong><br><br>`;
                Object.entries(summary).forEach(([slotName, count]) => {
                    summaryText += `<span class="inline-block bg-gray-100 px-2 py-1 rounded text-sm mr-2 mb-1">${slotName}: ${count}</span>`;
                });
                
                countDisplay.innerHTML = summaryText;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function updatePageStatus() {
            const statusElement = document.getElementById('page-status');
            const hasBeenSaved = renderer.hasPageBeenSaved();
            
            if (hasBeenSaved) {
                statusElement.textContent = 'Page: SAVED';
                statusElement.className = 'px-3 py-1 bg-green-100 text-green-700 rounded text-sm';
            } else {
                statusElement.textContent = 'Page: NEW/UNSAVED';
                statusElement.className = 'px-3 py-1 bg-yellow-100 text-yellow-700 rounded text-sm';
            }
        }

        function updateSavedDataDisplay(widgetData) {
            const display = document.getElementById('saved-data-display');
            const jsonPre = document.getElementById('saved-data-json');
            
            if (widgetData && Object.keys(widgetData).length > 0) {
                jsonPre.textContent = JSON.stringify(widgetData, null, 2);
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function loadSavedPageData() {
            try {
                const savedData = localStorage.getItem('demo-page-widgets');
                if (savedData) {
                    const widgetData = JSON.parse(savedData);
                    return widgetData;
                }
            } catch (error) {
                console.error('Error loading saved page data:', error);
            }
            return null;
        }

        function hasSavedPageData() {
            const savedData = localStorage.getItem('demo-page-widgets');
            return savedData && savedData !== 'null' && savedData !== '{}';
        }

        function updateDirtyStatus(isDirty, reason) {
            const statusElement = document.getElementById('dirty-status');
            
            if (isDirty) {
                statusElement.textContent = 'UNSAVED CHANGES';
                statusElement.className = 'px-3 py-1 bg-yellow-100 text-yellow-700 rounded text-sm';
                statusElement.classList.remove('hidden');
            } else {
                statusElement.classList.add('hidden');
            }
            
            updatePageStatus(); // Update main status as well
        }

        function showAutoSaveStatus(message, type = 'info') {
            const statusElement = document.getElementById('autosave-status');
            
            statusElement.textContent = message;
            
            if (type === 'success') {
                statusElement.className = 'px-3 py-1 bg-green-100 text-green-700 rounded text-sm';
            } else if (type === 'error') {
                statusElement.className = 'px-3 py-1 bg-red-100 text-red-700 rounded text-sm';
            } else {
                statusElement.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm';
            }
            
            statusElement.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 3000);
        }

        // Button handlers
        document.getElementById('render-layout').addEventListener('click', () => {
            renderer.render(demoLayout, targetRef);
            console.log('Layout rendered with automatic slot menus');
        });

        document.getElementById('count-widgets').addEventListener('click', () => {
            updateWidgetSummary();
            const { totalWidgets } = countWidgetsInSlots();
            if (totalWidgets === 0) {
                alert('No widgets added yet! Click ••• on any slot and select "Add Widget".');
            }
        });

        document.getElementById('clear-all-widgets').addEventListener('click', () => {
            const { totalWidgets } = countWidgetsInSlots();
            if (totalWidgets === 0) {
                alert('No widgets to clear!');
                return;
            }
            
            if (confirm(`Clear all ${totalWidgets} widgets from all slots?`)) {
                // Clear all widgets from all slots
                const slots = document.querySelectorAll('[data-slot-name]');
                slots.forEach(slot => {
                    const widgets = slot.querySelectorAll('.rendered-widget');
                    widgets.forEach(widget => widget.remove());
                    
                    // Add placeholder back if slot is now empty
                    if (slot.children.length === 1) { // Only slot menu remains
                        const slotName = slot.getAttribute('data-slot-name');
                        const slotConfig = renderer.getSlotConfig(slotName);
                        const placeholder = document.createElement('div');
                        placeholder.className = 'slot-placeholder p-4 border-2 border-dashed border-gray-300 rounded text-center text-gray-500';
                        placeholder.innerHTML = `
                            <div class="text-sm font-medium">${slotConfig?.title || slotName}</div>
                            ${slotConfig?.description ? `<div class="text-xs mt-1">${slotConfig.description}</div>` : ''}
                            <div class="text-xs mt-2 opacity-75">Click ••• to add widgets</div>
                        `;
                        slot.appendChild(placeholder);
                    }
                });
                
                updateWidgetSummary();
                showSuccessMessage('All widgets cleared!');
            }
        });

        document.getElementById('save-page').addEventListener('click', () => {
            const widgetData = renderer.saveCurrentWidgetState();
            updatePageStatus();
            updateWidgetSummary();
            showSuccessMessage(`Page saved with ${Object.keys(widgetData).length} slots and widget data!`);
        });

        document.getElementById('load-page').addEventListener('click', () => {
            const savedData = loadSavedPageData();
            if (savedData) {
                console.log('Manually loading saved widget data:', savedData);
                
                // Load widget data into renderer (this takes priority over defaults)
                renderer.loadWidgetData(savedData);
                
                // Re-render the layout with loaded data (saved widgets will be used instead of defaults)
                renderer.render(demoLayout, targetRef);
                
                updatePageStatus();
                updateWidgetSummary();
                updateSavedDataDisplay(savedData);
                showSuccessMessage(`Loaded page with ${Object.keys(savedData).length} slots of widget data!`);
                console.log('Saved widgets loaded - they will take priority over any defaults');
            } else {
                alert('No saved page data found. Save a page first!');
            }
        });

        document.getElementById('reset-page').addEventListener('click', () => {
            if (confirm('Reset to new page? This will clear all widgets and re-enable default widget auto-creation.')) {
                renderer.resetPageSavedState();
                renderer.render(demoLayout, targetRef);
                updatePageStatus();
                updateWidgetSummary();
                updateSavedDataDisplay({});
                showSuccessMessage('Page reset! Default widgets will auto-create again.');
            }
        });

        document.getElementById('toggle-saved-data').addEventListener('click', () => {
            const content = document.getElementById('saved-data-content');
            const button = document.getElementById('toggle-saved-data');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.textContent = 'Hide Details';
            } else {
                content.classList.add('hidden');
                button.textContent = 'Show Details';
            }
        });

        document.getElementById('toggle-autosave').addEventListener('click', () => {
            const button = document.getElementById('toggle-autosave');
            const currentlyEnabled = renderer.autoSaveEnabled;
            
            if (currentlyEnabled) {
                renderer.setAutoSaveConfig({ enabled: false });
                button.textContent = 'Enable Auto-Save';
                button.className = 'px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700';
                showAutoSaveStatus('Auto-save disabled', 'info');
            } else {
                renderer.setAutoSaveConfig({ enabled: true, delay: 2000 });
                button.textContent = 'Disable Auto-Save';
                button.className = 'px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700';
                showAutoSaveStatus('Auto-save enabled (2s delay)', 'success');
            }
        });

        // Auto-render layout on page load
        setTimeout(() => {
            // Check if we have saved data to load BEFORE rendering
            if (hasSavedPageData()) {
                const savedData = loadSavedPageData();
                if (savedData) {
                    console.log('Loading saved widget data before render:', savedData);
                    renderer.loadWidgetData(savedData);
                    updateSavedDataDisplay(savedData);
                    console.log('Saved widgets will take priority over defaults');
                } else {
                    console.log('No valid saved data found, defaults will be used if available');
                }
            } else {
                console.log('No saved data found, defaults will be used if available');
            }
            
            renderer.render(demoLayout, targetRef);
            updatePageStatus();
            updateWidgetSummary();
        }, 500);

        // Make renderer available for debugging
        window.layoutRenderer = renderer;
    </script>
</body>
</html> 