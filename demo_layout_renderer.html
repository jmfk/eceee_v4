<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Layout Markup Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-editable {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .slot-editable:hover {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        .slot-selected {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.6) !important;
        }
        
        .widget-item:hover .widget-edit-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">JSON Layout Markup Demo</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Layout JSON Display -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Layout JSON Structure</h2>
                <div class="mb-4">
                    <button id="loadLayout" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Load Layout from API</button>
                    <select id="layoutSelect" class="ml-2 border border-gray-300 rounded px-3 py-2">
                        <option value="single_column">Single Column</option>
                        <option value="two_column">Two Column</option>
                        <option value="three_column">Three Column</option>
                    </select>
                </div>
                <pre id="jsonDisplay" class="bg-gray-100 p-4 rounded text-xs overflow-auto max-h-96 font-mono"></pre>
            </div>
            
            <!-- Rendered Layout -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Rendered Layout</h2>
                <div class="mb-4">
                    <button id="renderLayout" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Render Layout</button>
                    <button id="updateSlot" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 ml-2">Update Main Slot</button>
                </div>
                <div id="layoutContainer" class="border border-gray-300 rounded p-4 min-h-64 bg-gray-50"></div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Interactive Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Slot Information</h3>
                    <div id="slotInfo" class="text-sm text-gray-600">Click on a slot to see details</div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Available Slots</h3>
                    <div id="slotList" class="text-sm text-gray-600">Load a layout first</div>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Actions</h3>
                    <button id="clearSlots" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Clear All Slots</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple LayoutRenderer implementation for demo
        class LayoutRenderer {
            constructor() {
                this.slotContainers = new Map();
                this.slotConfigs = new Map();
            }

            render(layout, targetElement) {
                if (!targetElement) return;
                
                targetElement.innerHTML = '';
                this.slotContainers.clear();
                this.slotConfigs.clear();

                const rootElement = this.renderNode(layout.structure || layout);
                targetElement.appendChild(rootElement);

                // Set up slot interactivity
                this.setupSlotInteractivity(targetElement);
            }

            renderNode(node) {
                if (!node || typeof node !== 'object') {
                    return document.createTextNode(String(node || ''));
                }

                switch (node.type) {
                    case 'element':
                        return this.renderElement(node);
                    case 'slot':
                        return this.renderSlotElement(node);
                    case 'text':
                        return document.createTextNode(node.content || '');
                    default:
                        return document.createTextNode('');
                }
            }

            renderElement(node) {
                const element = document.createElement(node.tag || 'div');

                if (node.classes) {
                    element.className = node.classes;
                }

                if (node.attributes) {
                    Object.entries(node.attributes).forEach(([key, value]) => {
                        if (key !== 'class') {
                            element.setAttribute(key, Array.isArray(value) ? value.join(' ') : String(value));
                        }
                    });
                }

                if (node.children && Array.isArray(node.children)) {
                    node.children.forEach(child => {
                        const childElement = this.renderNode(child);
                        if (childElement) {
                            element.appendChild(childElement);
                        }
                    });
                }

                return element;
            }

            renderSlotElement(node) {
                const element = document.createElement(node.tag || 'div');

                if (node.classes) {
                    element.className = node.classes;
                }

                if (node.attributes) {
                    Object.entries(node.attributes).forEach(([key, value]) => {
                        if (key !== 'class') {
                            element.setAttribute(key, Array.isArray(value) ? value.join(' ') : String(value));
                        }
                    });
                }

                const slotName = node.slot?.name;
                if (slotName) {
                    element.setAttribute('data-slot-name', slotName);
                    element.setAttribute('data-slot-title', node.slot.title || '');
                    element.classList.add('slot-editable');
                    
                    this.slotContainers.set(slotName, element);
                    this.slotConfigs.set(slotName, node.slot);

                    // Render default widgets
                    if (node.slot.defaultWidgets?.length > 0) {
                        node.slot.defaultWidgets.forEach(widget => {
                            const widgetElement = this.renderWidget(widget);
                            if (widgetElement) {
                                element.appendChild(widgetElement);
                            }
                        });
                    } else {
                        element.innerHTML = `
                            <div class="slot-placeholder p-4 border-2 border-dashed border-gray-300 rounded text-center text-gray-500">
                                <div class="text-sm font-medium">${node.slot.title || slotName}</div>
                                ${node.slot.description ? `<div class="text-xs mt-1">${node.slot.description}</div>` : ''}
                                <div class="text-xs mt-2 opacity-75">Click to interact</div>
                            </div>
                        `;
                    }
                }

                return element;
            }

            renderWidget(widget) {
                const element = document.createElement('div');
                element.className = 'widget-item bg-white border border-gray-200 rounded p-3 mb-2 shadow-sm';
                
                let content = '';
                switch (widget.type) {
                    case 'text':
                        content = `
                            <div class="text-sm font-medium text-gray-700 mb-1">Text Widget</div>
                            <div class="text-gray-900 text-sm">${widget.config?.content || 'No content'}</div>
                        `;
                        break;
                    case 'image':
                        content = `
                            <div class="text-sm font-medium text-gray-700 mb-1">Image Widget</div>
                            <div class="bg-gray-100 border border-gray-200 rounded p-4 text-center text-gray-500 text-xs">
                                ðŸ“· ${widget.config?.alt || 'Image placeholder'}
                            </div>
                        `;
                        break;
                    case 'recent_posts':
                        const count = widget.config?.count || 3;
                        content = `
                            <div class="text-sm font-medium text-gray-700 mb-1">Recent Posts</div>
                            <div class="space-y-1 text-xs">
                                ${Array.from({length: count}, (_, i) => 
                                    `<div class="flex justify-between"><span>Sample Post ${i + 1}</span><span class="text-gray-500">Dec ${i + 1}</span></div>`
                                ).join('')}
                            </div>
                        `;
                        break;
                    case 'social_media':
                        const platforms = widget.config?.platforms || [];
                        content = `
                            <div class="text-sm font-medium text-gray-700 mb-1">Social Media</div>
                            <div class="flex space-x-2">
                                ${platforms.map(platform => 
                                    `<div class="w-6 h-6 bg-blue-500 rounded flex items-center justify-center text-white text-xs">${platform[0].toUpperCase()}</div>`
                                ).join('')}
                            </div>
                        `;
                        break;
                    default:
                        content = `
                            <div class="text-sm font-medium text-gray-700 mb-1">${widget.type} Widget</div>
                            <pre class="text-xs text-gray-500 bg-gray-50 p-2 rounded">${JSON.stringify(widget.config, null, 2)}</pre>
                        `;
                }

                element.innerHTML = content;
                return element;
            }

            setupSlotInteractivity(container) {
                const slotElements = container.querySelectorAll('[data-slot-name]');
                
                slotElements.forEach(slotElement => {
                    const slotName = slotElement.getAttribute('data-slot-name');
                    
                    slotElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        // Update slot info display
                        const slotConfig = this.slotConfigs.get(slotName);
                        document.getElementById('slotInfo').innerHTML = `
                            <strong>Slot:</strong> ${slotName}<br>
                            <strong>Title:</strong> ${slotConfig?.title || 'N/A'}<br>
                            <strong>Description:</strong> ${slotConfig?.description || 'N/A'}<br>
                            <strong>Max widgets:</strong> ${slotConfig?.maxWidgets || 'Unlimited'}
                        `;
                        
                        // Visual selection
                        document.querySelectorAll('.slot-selected').forEach(el => {
                            el.classList.remove('slot-selected');
                        });
                        slotElement.classList.add('slot-selected');
                    });
                });
            }

            updateSlot(slotName, widgets) {
                const container = this.slotContainers.get(slotName);
                if (!container) return;

                container.innerHTML = '';
                widgets.forEach(widget => {
                    const widgetElement = this.renderWidget(widget);
                    if (widgetElement) {
                        container.appendChild(widgetElement);
                    }
                });
            }

            getSlotNames() {
                return Array.from(this.slotContainers.keys());
            }
        }

        // Demo application
        let currentLayoutData = null;
        const renderer = new LayoutRenderer();

        // Load layout from API
        document.getElementById('loadLayout').addEventListener('click', async () => {
            const layoutName = document.getElementById('layoutSelect').value;
            try {
                const response = await fetch(`/api/v1/webpages/layouts/${layoutName}/json/`);
                const data = await response.json();
                
                currentLayoutData = data;
                document.getElementById('jsonDisplay').textContent = JSON.stringify(data, null, 2);
                
                console.log('Layout loaded:', data);
            } catch (error) {
                console.error('Error loading layout:', error);
                document.getElementById('jsonDisplay').textContent = 'Error loading layout: ' + error.message;
            }
        });

        // Render layout
        document.getElementById('renderLayout').addEventListener('click', () => {
            if (!currentLayoutData) {
                alert('Please load a layout first');
                return;
            }

            const container = document.getElementById('layoutContainer');
            renderer.render(currentLayoutData, container);
            
            // Update slot list
            const slotNames = renderer.getSlotNames();
            document.getElementById('slotList').innerHTML = slotNames.length > 0 
                ? slotNames.map(name => `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${name}</span>`).join('')
                : 'No slots found';
        });

        // Update main slot with custom widgets
        document.getElementById('updateSlot').addEventListener('click', () => {
            const customWidgets = [
                {
                    type: 'text',
                    config: { content: '<h3>Custom Content</h3><p>This content was added dynamically!</p>' }
                },
                {
                    type: 'recent_posts',
                    config: { count: 2, show_excerpt: true }
                }
            ];

            renderer.updateSlot('main', customWidgets);
        });

        // Clear all slots
        document.getElementById('clearSlots').addEventListener('click', () => {
            const slotNames = renderer.getSlotNames();
            slotNames.forEach(slotName => {
                renderer.updateSlot(slotName, []);
            });
        });

        // Load default layout on page load
        window.addEventListener('load', () => {
            document.getElementById('loadLayout').click();
        });
    </script>
</body>
</html>