{% if config.display_type == 'gallery' and config.media_items %}
    <!-- Gallery Display -->
    <div class="image-widget gallery-widget" data-widget-type="gallery">
        <div class="gallery-container" 
             data-columns="{{ config.gallery_columns|default:3 }}"
             data-show-captions="{{ config.show_captions|yesno:'true,false' }}"
             data-enable-lightbox="{{ config.enable_lightbox|yesno:'true,false' }}">
            
            <div class="gallery-grid" 
                 style="grid-template-columns: repeat({{ config.gallery_columns|default:3 }}, 1fr);">
                {% for item in config.media_items %}
                    <div class="gallery-item" data-index="{{ forloop.counter0 }}">
                        <div class="image-container">
                            {% if item.type == 'video' %}
                                <video 
                                    src="{{ item.url }}" 
                                    class="gallery-image"
                                    {% if config.auto_play %}autoplay loop muted{% endif %}
                                    loading="lazy">
                                </video>
                            {% else %}
                                <img 
                                    src="{{ item.thumbnail_url|default:item.url }}" 
                                    alt="{{ item.alt_text }}"
                                    class="gallery-image"
                                    loading="lazy"
                                    {% if config.enable_lightbox %}
                                        onclick="openLightbox({{ forloop.counter0 }})"
                                        style="cursor: pointer;"
                                    {% endif %}>
                            {% endif %}
                            
                            {% if config.enable_lightbox %}
                                <div class="image-overlay">
                                    <span class="expand-icon">üîç</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if config.show_captions and item.caption %}
                            <div class="image-caption">
                                {{ item.caption }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        {% if config.enable_lightbox %}
            <!-- Lightbox Modal -->
            <div class="lightbox-modal" id="lightbox-modal-{{ widget.id }}" style="display: none;" onclick="closeLightbox(event)">
                <div class="lightbox-content">
                    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
                    
                    <div class="lightbox-image-container">
                        <img id="lightbox-image-{{ widget.id }}" src="" alt="" class="lightbox-image">
                        
                        {% if config.media_items|length > 1 %}
                            <button class="lightbox-btn lightbox-prev" onclick="lightboxChangeSlide(-1)">‚óÄ</button>
                            <button class="lightbox-btn lightbox-next" onclick="lightboxChangeSlide(1)">‚ñ∂</button>
                        {% endif %}
                    </div>
                    
                    <div class="lightbox-info" id="lightbox-info-{{ widget.id }}">
                        <h3 id="lightbox-caption-{{ widget.id }}"></h3>
                    </div>
                    
                    {% if config.media_items|length > 1 %}
                        <div class="lightbox-counter" id="lightbox-counter-{{ widget.id }}"></div>
                    {% endif %}
                </div>
            </div>

            <script type="application/json" id="gallery-images-data-{{ widget.id }}">
                {{ config.media_items|safe }}
            </script>
            
            <script>
            (function() {
                let currentLightboxIndex = 0;
                let galleryImages = [];

                document.addEventListener('DOMContentLoaded', function() {
                    const imagesDataEl = document.getElementById('gallery-images-data-{{ widget.id }}');
                    if (imagesDataEl) {
                        galleryImages = JSON.parse(imagesDataEl.textContent || '[]');
                    }
                });

                window.openLightbox = function(index) {
                    const modal = document.getElementById('lightbox-modal-{{ widget.id }}');
                    const lightboxImage = document.getElementById('lightbox-image-{{ widget.id }}');
                    const lightboxCaption = document.getElementById('lightbox-caption-{{ widget.id }}');
                    const lightboxCounter = document.getElementById('lightbox-counter-{{ widget.id }}');
                    
                    if (!modal || !galleryImages[index]) return;
                    
                    currentLightboxIndex = index;
                    const image = galleryImages[index];
                    
                    lightboxImage.src = image.url;
                    lightboxImage.alt = image.alt_text;
                    
                    if (lightboxCaption) lightboxCaption.textContent = image.caption || '';
                    
                    if (lightboxCounter && galleryImages.length > 1) {
                        lightboxCounter.textContent = `${index + 1} / ${galleryImages.length}`;
                    }
                    
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                };

                window.closeLightbox = function(event) {
                    if (event && event.target !== event.currentTarget && !event.target.classList.contains('lightbox-close')) {
                        return;
                    }
                    
                    const modal = document.getElementById('lightbox-modal-{{ widget.id }}');
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                };

                window.lightboxChangeSlide = function(direction) {
                    const totalImages = galleryImages.length;
                    currentLightboxIndex = (currentLightboxIndex + direction + totalImages) % totalImages;
                    openLightbox(currentLightboxIndex);
                };

                // Keyboard navigation
                document.addEventListener('keydown', function(event) {
                    const modal = document.getElementById('lightbox-modal-{{ widget.id }}');
                    if (modal && modal.style.display === 'flex') {
                        switch(event.key) {
                            case 'Escape':
                                closeLightbox();
                                break;
                            case 'ArrowLeft':
                                lightboxChangeSlide(-1);
                                break;
                            case 'ArrowRight':
                                lightboxChangeSlide(1);
                                break;
                        }
                    }
                });
            })();
            </script>
        {% endif %}
    </div>

{% elif config.display_type == 'carousel' and config.media_items %}
    <!-- Carousel Display -->
    <div class="image-widget carousel-widget" data-widget-type="carousel">
        <div class="carousel-container">
            <div class="carousel-track" id="carousel-track-{{ widget.id }}">
                {% for item in config.media_items %}
                    <div class="carousel-slide" data-index="{{ forloop.counter0 }}">
                        {% if item.type == 'video' %}
                            <video 
                                src="{{ item.url }}" 
                                class="carousel-image"
                                {% if config.auto_play %}autoplay loop muted{% endif %}>
                            </video>
                        {% else %}
                            <img 
                                src="{{ item.thumbnail_url|default:item.url }}" 
                                alt="{{ item.alt_text }}"
                                class="carousel-image">
                        {% endif %}
                        {% if config.show_captions and item.caption %}
                            <div class="carousel-caption">{{ item.caption }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            {% if config.media_items|length > 1 %}
                <button class="carousel-btn carousel-prev" onclick="changeSlide{{ widget.id }}(-1)">‚óÄ</button>
                <button class="carousel-btn carousel-next" onclick="changeSlide{{ widget.id }}(1)">‚ñ∂</button>
                
                <div class="carousel-indicators">
                    {% for item in config.media_items %}
                        <button class="indicator-dot {% if forloop.first %}active{% endif %}" 
                                onclick="goToSlide{{ widget.id }}({{ forloop.counter0 }})"></button>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <script>
        (function() {
            let currentSlide = 0;

            window.changeSlide{{ widget.id }} = function(direction) {
                const track = document.getElementById('carousel-track-{{ widget.id }}');
                const slides = track.querySelectorAll('.carousel-slide');
                const totalSlides = slides.length;
                
                currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
                updateCarousel{{ widget.id }}();
            };

            window.goToSlide{{ widget.id }} = function(index) {
                currentSlide = index;
                updateCarousel{{ widget.id }}();
            };

            function updateCarousel{{ widget.id }}() {
                const track = document.getElementById('carousel-track-{{ widget.id }}');
                const container = track.closest('.carousel-widget');
                const indicators = container.querySelectorAll('.indicator-dot');
                
                if (track) {
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }
                
                indicators.forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === currentSlide);
                });
            }

            {% if config.auto_play %}
            // Auto-play functionality
            setInterval(function() {
                changeSlide{{ widget.id }}(1);
            }, {{ config.auto_play_interval|default:3 }} * 1000);
            {% endif %}
        })();
        </script>
    </div>

{% else %}
    <!-- Single Image Display -->
    <div class="image-widget image-size-{{ config.size|default:'medium' }} image-align-{{ config.alignment|default:'center' }}">
        {% if config.media_items and config.media_items|length > 0 %}
            {% with item=config.media_items.0 %}
                <div class="image-container">
                    {% if item.type == 'video' %}
                        <video 
                            src="{{ item.url }}" 
                            class="widget-image"
                            {% if config.auto_play %}autoplay loop muted{% endif %}
                            loading="lazy">
                        </video>
                    {% else %}
                        <img 
                            src="{{ item.url }}" 
                            alt="{{ item.alt_text }}"
                            class="widget-image"
                            loading="lazy"
                        />
                    {% endif %}
                </div>
                
                {% if config.show_captions and item.caption %}
                    <div class="image-caption">
                        {{ item.caption }}
                    </div>
                {% endif %}
            {% endwith %}
        {% elif config.image_url %}
            <div class="image-container">
                <img 
                    src="{{ config.image_url }}" 
                    alt="{{ config.alt_text }}"
                    class="widget-image"
                    loading="lazy"
                />
            </div>
            
            {% if config.caption %}
                <div class="image-caption">
                    {{ config.caption }}
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endif %}

<style>
.image-widget {
    margin: 1rem 0;
}

.image-widget.image-align-left {
    text-align: left;
}

.image-widget.image-align-center {
    text-align: center;
}

.image-widget.image-align-right {
    text-align: right;
}

.image-widget.image-size-small .widget-image {
    max-width: 200px;
    width: 100%;
}

.image-widget.image-size-medium .widget-image {
    max-width: 400px;
    width: 100%;
}

.image-widget.image-size-large .widget-image {
    max-width: 600px;
    width: 100%;
}

.image-widget.image-size-full .widget-image {
    width: 100%;
}

.widget-image {
    height: auto;
    border-radius: 4px;
}

.image-caption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    font-style: italic;
}

/* Gallery Styles */
.gallery-widget {
    border-radius: 8px;
    padding: 1rem;
}

.gallery-grid {
    display: grid;
    gap: 1rem;
}

.gallery-item {
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.gallery-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.image-container {
    position: relative;
    overflow: hidden;
}

.gallery-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s;
}

.gallery-item:hover .gallery-image {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.gallery-item:hover .image-overlay {
    opacity: 1;
}

.expand-icon {
    font-size: 1.5rem;
    color: white;
}

/* Carousel Styles */
.carousel-widget {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
}

.carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
}

.carousel-track {
    display: flex;
    transition: transform 0.5s ease;
}

.carousel-slide {
    min-width: 100%;
    position: relative;
}

.carousel-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: block;
}

.carousel-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    padding: 2rem 1.5rem 1rem;
    font-size: 1.125rem;
    font-weight: 500;
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.25rem;
    color: #2d3748;
    transition: background-color 0.2s;
    z-index: 2;
}

.carousel-btn:hover {
    background: white;
}

.carousel-prev { left: 1rem; }
.carousel-next { right: 1rem; }

.carousel-indicators {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 2;
}

.indicator-dot {
    width: 0.75rem;
    height: 0.75rem;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    transition: background-color 0.2s;
}

.indicator-dot.active {
    background: white;
}

/* Lightbox Styles */
.lightbox-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 2rem;
}

.lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lightbox-image-container {
    position: relative;
}

.lightbox-image {
    max-width: 100%;
    max-height: 70vh;
    width: auto;
    height: auto;
    display: block;
}

.lightbox-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    font-size: 1.25rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.lightbox-btn:hover {
    background: rgba(0,0,0,0.9);
}

.lightbox-prev { left: 1rem; }
.lightbox-next { right: 1rem; }

.lightbox-info {
    padding: 1.5rem;
}

.lightbox-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: #2d3748;
}

.lightbox-counter {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .gallery-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem;
    }
    
    .carousel-image {
        height: 250px;
    }
    
    .carousel-btn {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .gallery-grid {
        grid-template-columns: 1fr !important;
    }
}
</style>