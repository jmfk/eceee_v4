{% load static %}
{% load security_filters %}

<nav class="navigation-widget {% if config.sticky %}sticky-nav{% endif %} {% if config.css_class %}{{ config.css_class }}{% endif %}"
     {% if config.background_color or config.background_image or config.text_color or config.padding or config.margin %}
         style="
             {% if config.background_color %}background-color: {{ config.background_color }};{% endif %}
             {% if config.background_image %}
                 background-image: url('{{ config.background_image }}');
                 background-size: {{ config.background_size|default:'cover' }};
                 background-position: {{ config.background_position|default:'center' }};
                 background-repeat: no-repeat;
             {% endif %}
             {% if config.text_color %}color: {{ config.text_color }};{% endif %}
             {% if config.padding %}padding: {{ config.padding }};{% endif %}
             {% if config.margin %}margin: {{ config.margin }};{% endif %}
             {% if config.text_align != 'left' %}text-align: {{ config.text_align }};{% endif %}
         "
     {% endif %}>
    
    <div class="nav-container">
        {% if config.brand_name or config.brand_logo %}
            <div class="nav-brand">
                {% if config.brand_logo %}
                    <img src="{{ config.brand_logo }}" alt="{{ config.brand_name|default:'Logo' }}" class="nav-brand-logo">
                {% endif %}
                {% if config.brand_name %}
                    {% if config.brand_url %}
                        <a href="{{ config.brand_url }}" class="nav-brand-text">{{ config.brand_name }}</a>
                    {% else %}
                        <span class="nav-brand-text">{{ config.brand_name }}</span>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
        
        {% if config.mobile_friendly %}
            <button class="nav-toggle" onclick="toggleNavMenu()" aria-label="Toggle navigation">
                <span class="nav-toggle-icon">☰</span>
            </button>
        {% endif %}
        
        {% if config.menu_items %}
            <ul class="nav-menu" id="nav-menu">
                {% for item in config.menu_items %}
                    <li class="nav-item {% if item.children and config.dropdown_enabled %}nav-dropdown{% endif %}">
                        <a href="{{ item.url }}" 
                           class="nav-link {% if item.is_active %}active{% endif %}"
                           {% if item.children and config.dropdown_enabled %}onclick="toggleDropdown(event)"{% endif %}>
                            {{ item.label }}
                            {% if item.children and config.dropdown_enabled %}
                                <span class="dropdown-arrow">▼</span>
                            {% endif %}
                        </a>
                        
                        {% if item.children and config.dropdown_enabled %}
                            <ul class="nav-dropdown-menu">
                                {% for child in item.children %}
                                    <li class="nav-dropdown-item">
                                        <a href="{{ child.url }}" 
                                           class="nav-dropdown-link {% if child.is_active %}active{% endif %}">
                                            {{ child.label }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <!-- Fallback: render content if no menu items -->
            <div class="nav-content">
                {{ config.content|sanitize_html }}
            </div>
        {% endif %}
    </div>
    
    {% if config.custom_css %}
        <style>
            {{ config.custom_css|safe }}
        </style>
    {% endif %}
    
    <script>
        function toggleNavMenu() {
            const menu = document.getElementById('nav-menu');
            menu.classList.toggle('active');
        }
        
        function toggleDropdown(event) {
            event.preventDefault();
            const dropdownItem = event.target.closest('.nav-dropdown');
            const dropdownMenu = dropdownItem.querySelector('.nav-dropdown-menu');
            
            // Close other open dropdowns
            document.querySelectorAll('.nav-dropdown-menu.active').forEach(menu => {
                if (menu !== dropdownMenu) {
                    menu.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdownMenu.classList.toggle('active');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown-menu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });
        
        // Handle sticky navigation
        {% if config.sticky %}
        window.addEventListener('scroll', function() {
            const nav = document.querySelector('.navigation-widget');
            if (window.scrollY > 100) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });
        {% endif %}
    </script>
</nav>
