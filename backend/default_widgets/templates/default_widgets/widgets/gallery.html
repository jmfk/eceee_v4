{% load static %}

<div class="gallery-widget widget-gallery" data-widget-type="gallery">
    {% if config.title %}
        <header class="gallery-header">
            <h2 class="gallery-title">{{ config.title }}</h2>
        </header>
    {% endif %}

    <div class="gallery-container" 
         data-layout="{{ config.layout|default:'grid' }}"
         data-columns="{{ config.columns|default:3 }}"
         data-show-captions="{{ config.show_captions|yesno:'true,false' }}"
         data-enable-lightbox="{{ config.enable_lightbox|yesno:'true,false' }}"
         data-auto-play="{{ config.auto_play|yesno:'true,false' }}">
         
        {% if config.layout == 'carousel' %}
            <div class="gallery-carousel" id="gallery-carousel">
                <div class="carousel-container">
                    <div class="carousel-track" id="carousel-track">
                        {% for image in config.media_items %}
                            <div class="carousel-slide" data-index="{{ forloop.counter0 }}">
                                                                 <img src="{{ image.thumbnail_url|default:image.url }}" 
                                     alt="{{ image.alt_text }}"
                                     class="carousel-image{% if config.enable_lightbox %} lightbox-trigger{% endif %}"
                                     data-index="{{ forloop.counter0 }}"
                                     {% if config.enable_lightbox %}style="cursor: pointer;"{% endif %}>
                                {% if config.show_captions and image.caption %}
                                    <div class="carousel-caption">{{ image.caption }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if config.media_items|length > 1 %}
                        <button class="carousel-btn carousel-prev" data-direction="-1">
                            <i class="icon-prev" aria-hidden="true"></i>
                        </button>
                        <button class="carousel-btn carousel-next" data-direction="1">
                            <i class="icon-next" aria-hidden="true"></i>
                        </button>
                        
                        <div class="carousel-indicators">
                            {% for image in config.media_items %}
                                <button class="indicator-dot {% if forloop.first %}active{% endif %}" 
                                        data-slide-index="{{ forloop.counter0 }}"></button>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
        {% else %}
            <!-- Grid, Masonry, or Lightbox layouts -->
            <div class="gallery-grid" 
                 style="grid-template-columns: repeat({{ config.columns|default:3 }}, 1fr);">
                {% for image in config.media_items %}
                    <div class="gallery-item" data-index="{{ forloop.counter0 }}">
                        <div class="image-container">
                            <img src="{{ image.thumbnail_url|default:image.url }}" 
                                 alt="{{ image.alt_text }}"
                                 class="gallery-image"
                                 loading="lazy"
                                 {% if config.enable_lightbox %}
                                     onclick="openLightbox({{ forloop.counter0 }})"
                                     style="cursor: pointer;"
                                 {% endif %}>
                            
                            {% if config.enable_lightbox %}
                                <div class="image-overlay">
                                    <i class="icon-expand" aria-hidden="true"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if config.show_captions and image.caption %}
                            <div class="image-caption">
                                <h4 class="caption-title">{{ image.caption }}</h4>
                                {% if image.description %}
                                    <p class="caption-description">{{ image.description }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {% if config.enable_lightbox %}
        <!-- Lightbox Modal -->
        <div class="lightbox-modal" id="lightbox-modal" style="display: none;" onclick="closeLightbox(event)">
            <div class="lightbox-content">
                <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
                
                <div class="lightbox-image-container">
                    <img id="lightbox-image" src="" alt="" class="lightbox-image">
                    
                                {% if config.media_items|length > 1 %}
                        <button class="lightbox-btn lightbox-prev" onclick="lightboxChangeSlide(-1)">
                            <i class="icon-prev" aria-hidden="true"></i>
                        </button>
                        <button class="lightbox-btn lightbox-next" onclick="lightboxChangeSlide(1)">
                            <i class="icon-next" aria-hidden="true"></i>
                        </button>
                    {% endif %}
                </div>
                
                <div class="lightbox-info" id="lightbox-info">
                    <h3 id="lightbox-caption"></h3>
                    <p id="lightbox-description"></p>
                </div>
                
                {% if config.media_items|length > 1 %}
                    <div class="lightbox-counter" id="lightbox-counter"></div>
                {% endif %}
            </div>
        </div>

        <!-- Store image data for lightbox -->
        <script type="application/json" id="gallery-images-data">
            {{ config.media_items|safe }}
        </script>
    {% endif %}
</div>

<script>
let currentSlide = 0;
let currentLightboxIndex = 0;
let galleryImages = [];
let autoPlayInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    const galleryWidget = document.querySelector('.gallery-widget');
    const imagesDataEl = document.getElementById('gallery-images-data');
    
    if (imagesDataEl) {
        galleryImages = JSON.parse(imagesDataEl.textContent || '[]');
    }
    
    const autoPlay = galleryWidget?.querySelector('.gallery-container')?.dataset.autoPlay === 'true';
    const layout = galleryWidget?.querySelector('.gallery-container')?.dataset.layout;
    
    // Initialize carousel auto-play if enabled
    if (autoPlay && layout === 'carousel' && galleryImages.length > 1) {
        startAutoPlay();
    }
    
    // Initialize masonry layout if needed
    if (layout === 'masonry') {
        initMasonryLayout();
    }
});

// Carousel functionality
function changeSlide(direction) {
    const track = document.getElementById('carousel-track');
    const slides = track.querySelectorAll('.carousel-slide');
    const totalSlides = slides.length;
    
    currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
    updateCarousel();
    resetAutoPlay();
}

function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
    resetAutoPlay();
}

function updateCarousel() {
    const track = document.getElementById('carousel-track');
    const indicators = document.querySelectorAll('.indicator-dot');
    
    if (track) {
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
    }
    
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentSlide);
    });
}

function startAutoPlay() {
    const autoPlayDelay = 5000; // 5 seconds
    autoPlayInterval = setInterval(() => {
        changeSlide(1);
    }, autoPlayDelay);
}

function resetAutoPlay() {
    if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
    }
}

// Lightbox functionality
function openLightbox(index) {
    const modal = document.getElementById('lightbox-modal');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxDescription = document.getElementById('lightbox-description');
    const lightboxCounter = document.getElementById('lightbox-counter');
    
    if (!modal || !galleryImages[index]) return;
    
    currentLightboxIndex = index;
    const image = galleryImages[index];
    
    lightboxImage.src = image.url;
    lightboxImage.alt = image.alt_text;
    
    if (lightboxCaption) lightboxCaption.textContent = image.caption || '';
    if (lightboxDescription) lightboxDescription.textContent = image.description || '';
    
    if (lightboxCounter && galleryImages.length > 1) {
        lightboxCounter.textContent = `${index + 1} / ${galleryImages.length}`;
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Stop carousel auto-play when lightbox opens
    if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
    }
}

function closeLightbox(event) {
    if (event && event.target !== event.currentTarget && !event.target.classList.contains('lightbox-close')) {
        return;
    }
    
    const modal = document.getElementById('lightbox-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // Restart auto-play if it was enabled
        const galleryContainer = document.querySelector('.gallery-container');
        if (galleryContainer?.dataset.autoPlay === 'true') {
            startAutoPlay();
        }
    }
}

function lightboxChangeSlide(direction) {
    const totalImages = galleryImages.length;
    currentLightboxIndex = (currentLightboxIndex + direction + totalImages) % totalImages;
    openLightbox(currentLightboxIndex);
}

// Masonry layout (basic implementation)
function initMasonryLayout() {
    const grid = document.querySelector('.gallery-grid');
    if (!grid) return;
    
    // This is a simplified masonry layout
    // For production, consider using a library like Masonry.js
    grid.style.display = 'columns';
    grid.style.columnGap = '1rem';
}

// Keyboard navigation for lightbox
document.addEventListener('keydown', function(event) {
    const modal = document.getElementById('lightbox-modal');
    if (modal && modal.style.display === 'flex') {
        switch(event.key) {
            case 'Escape':
                closeLightbox();
                break;
            case 'ArrowLeft':
                lightboxChangeSlide(-1);
                break;
            case 'ArrowRight':
                lightboxChangeSlide(1);
                break;
        }
    }
});
</script>

<style>
.gallery-widget {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gallery-header {
    margin-bottom: 1.5rem;
    text-align: center;
}

.gallery-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
    line-height: 1.2;
}

/* Grid Layout */
.gallery-grid {
    display: grid;
    gap: 1rem;
}

.gallery-item {
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.gallery-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.image-container {
    position: relative;
    overflow: hidden;
}

.gallery-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s;
}

.gallery-item:hover .gallery-image {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.gallery-item:hover .image-overlay {
    opacity: 1;
}

.image-caption {
    padding: 1rem;
}

.caption-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 0.5rem 0;
}

.caption-description {
    font-size: 0.875rem;
    color: #718096;
    margin: 0;
    line-height: 1.4;
}

/* Carousel Layout */
.gallery-carousel {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
}

.carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
}

.carousel-track {
    display: flex;
    transition: transform 0.5s ease;
}

.carousel-slide {
    min-width: 100%;
    position: relative;
}

.carousel-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: block;
}

.carousel-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    padding: 2rem 1.5rem 1rem;
    font-size: 1.125rem;
    font-weight: 500;
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.25rem;
    color: #2d3748;
    transition: background-color 0.2s;
    z-index: 2;
}

.carousel-btn:hover {
    background: white;
}

.carousel-prev { left: 1rem; }
.carousel-next { right: 1rem; }

.carousel-indicators {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 2;
}

.indicator-dot {
    width: 0.75rem;
    height: 0.75rem;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    transition: background-color 0.2s;
}

.indicator-dot.active {
    background: white;
}

/* Lightbox */
.lightbox-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 2rem;
}

.lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lightbox-image-container {
    position: relative;
}

.lightbox-image {
    max-width: 100%;
    max-height: 70vh;
    width: auto;
    height: auto;
    display: block;
}

.lightbox-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    font-size: 1.25rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.lightbox-btn:hover {
    background: rgba(0,0,0,0.9);
}

.lightbox-prev { left: 1rem; }
.lightbox-next { right: 1rem; }

.lightbox-info {
    padding: 1.5rem;
}

.lightbox-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: #2d3748;
}

.lightbox-info p {
    margin: 0;
    color: #718096;
    line-height: 1.5;
}

.lightbox-counter {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

/* Icons */
.icon-prev::before { content: "◀"; }
.icon-next::before { content: "▶"; }
.icon-expand::before { content: "🔍"; font-size: 1.5rem; color: white; }

/* Responsive Design */
@media (max-width: 768px) {
    .gallery-widget {
        padding: 1rem;
    }
    
    .gallery-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem;
    }
    
    .carousel-image {
        height: 250px;
    }
    
    .carousel-btn {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1rem;
    }
    
    .lightbox-modal {
        padding: 1rem;
    }
    
    .lightbox-btn {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .gallery-grid {
        grid-template-columns: 1fr !important;
    }
    
    .carousel-btn {
        width: 2rem;
        height: 2rem;
        font-size: 0.875rem;
    }
    
    .carousel-prev { left: 0.5rem; }
    .carousel-next { right: 0.5rem; }
}
</style> 