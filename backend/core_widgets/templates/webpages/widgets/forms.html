{% load static %}

<div class="forms-widget {% if config.css_class %}{{ config.css_class }}{% endif %}">
    <form method="{{ config.submit_method|default:'POST' }}" 
          {% if config.submit_url %}action="{{ config.submit_url }}"{% endif %}
          {% if config.ajax_submit %}onsubmit="return submitFormAjax(event, this)"{% endif %}
          class="widget-form {% if config.css_framework != 'default' %}{{ config.css_framework }}-form{% endif %}">
        
        {% csrf_token %}
        
        {% if config.honeypot_protection %}
            <!-- Honeypot field for spam protection -->
            <div style="display: none;">
                <label for="honeypot">Leave this field empty</label>
                <input type="text" name="honeypot" id="honeypot" tabindex="-1" autocomplete="off">
            </div>
        {% endif %}
        
        <div class="form-header">
            <h2 class="form-title">{{ config.title }}</h2>
            {% if config.description %}
                <p class="form-description">{{ config.description }}</p>
            {% endif %}
        </div>
        
        <div class="form-fields">
            {% for field in config.fields %}
                <div class="form-group field-{{ field.type }} {% if field.required %}required{% endif %} {% if field.css_class %}{{ field.css_class }}{% endif %}">
                    <label for="field_{{ field.name }}">
                        {{ field.label }}
                        {% if field.required %}<span class="required">*</span>{% endif %}
                    </label>
                    
                    {% if field.help_text %}
                        <small class="form-help">{{ field.help_text }}</small>
                    {% endif %}
                    
                    {% if field.type == 'text' or field.type == 'email' or field.type == 'phone' or field.type == 'number' %}
                        <input type="{{ field.type }}" 
                               id="field_{{ field.name }}" 
                               name="{{ field.name }}"
                               {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}
                               {% if field.default_value %}value="{{ field.default_value }}"{% endif %}
                               {% if field.required %}required{% endif %}
                               {% if field.validation %}
                                   {% for rule, value in field.validation.items %}
                                       {% if rule == 'min_length' %}minlength="{{ value }}"{% endif %}
                                       {% if rule == 'max_length' %}maxlength="{{ value }}"{% endif %}
                                       {% if rule == 'pattern' %}pattern="{{ value }}"{% endif %}
                                   {% endfor %}
                               {% endif %}>
                    
                    {% elif field.type == 'textarea' %}
                        <textarea id="field_{{ field.name }}" 
                                  name="{{ field.name }}"
                                  {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %}
                                  {% if field.required %}required{% endif %}
                                  {% if field.validation.max_length %}maxlength="{{ field.validation.max_length }}"{% endif %}
                                  rows="4">{% if field.default_value %}{{ field.default_value }}{% endif %}</textarea>
                    
                    {% elif field.type == 'select' %}
                        <select id="field_{{ field.name }}" 
                                name="{{ field.name }}"
                                {% if field.required %}required{% endif %}>
                            {% if not field.required %}
                                <option value="">{% if field.placeholder %}{{ field.placeholder }}{% else %}Select an option{% endif %}</option>
                            {% endif %}
                            {% for option in field.options %}
                                <option value="{{ option }}" {% if option == field.default_value %}selected{% endif %}>{{ option }}</option>
                            {% endfor %}
                        </select>
                    
                    {% elif field.type == 'checkbox' %}
                        {% if field.options %}
                            <div class="checkbox-group">
                                {% for option in field.options %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               id="field_{{ field.name }}_{{ forloop.counter0 }}" 
                                               name="{{ field.name }}" 
                                               value="{{ option }}"
                                               {% if option in field.default_value %}checked{% endif %}>
                                        <label for="field_{{ field.name }}_{{ forloop.counter0 }}">{{ option }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="field_{{ field.name }}" 
                                       name="{{ field.name }}"
                                       value="1"
                                       {% if field.default_value %}checked{% endif %}
                                       {% if field.required %}required{% endif %}>
                                <label for="field_{{ field.name }}">{{ field.label }}</label>
                            </div>
                        {% endif %}
                    
                    {% elif field.type == 'radio' %}
                        <div class="radio-group">
                            {% for option in field.options %}
                                <div class="radio-item">
                                    <input type="radio" 
                                           id="field_{{ field.name }}_{{ forloop.counter0 }}" 
                                           name="{{ field.name }}" 
                                           value="{{ option }}"
                                           {% if option == field.default_value %}checked{% endif %}
                                           {% if field.required %}required{% endif %}>
                                    <label for="field_{{ field.name }}_{{ forloop.counter0 }}">{{ option }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    
                    {% elif field.type == 'file' %}
                        <input type="file" 
                               id="field_{{ field.name }}" 
                               name="{{ field.name }}"
                               {% if field.required %}required{% endif %}
                               {% if field.validation.accept %}accept="{{ field.validation.accept }}"{% endif %}>
                    
                    {% elif field.type == 'date' %}
                        <input type="date" 
                               id="field_{{ field.name }}" 
                               name="{{ field.name }}"
                               {% if field.default_value %}value="{{ field.default_value }}"{% endif %}
                               {% if field.required %}required{% endif %}>
                    
                    {% elif field.type == 'time' %}
                        <input type="time" 
                               id="field_{{ field.name }}" 
                               name="{{ field.name }}"
                               {% if field.default_value %}value="{{ field.default_value }}"{% endif %}
                               {% if field.required %}required{% endif %}>
                    {% endif %}
                    
                    <div class="form-error" id="error_{{ field.name }}" style="display: none;"></div>
                </div>
            {% endfor %}
        </div>
        
        {% if config.recaptcha_enabled %}
            <div class="recaptcha-container">
                <!-- Add reCAPTCHA widget here -->
                <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
            </div>
        {% endif %}
        
        <div class="form-actions">
            <button type="submit" class="submit-button">
                {{ config.submit_button_text|default:'Submit' }}
            </button>
            
            {% if config.reset_button %}
                <button type="reset" class="reset-button">Reset</button>
            {% endif %}
        </div>
        
        <div class="form-messages">
            <div class="form-success" id="form-success" style="display: none;">
                {{ config.success_message }}
            </div>
            <div class="form-error" id="form-error" style="display: none;">
                {{ config.error_message }}
            </div>
        </div>
    </form>
</div>

{% if config.ajax_submit %}
<script>
function submitFormAjax(event, form) {
    event.preventDefault();
    
    // Clear previous messages
    document.getElementById('form-success').style.display = 'none';
    document.getElementById('form-error').style.display = 'none';
    
    // Clear field errors
    form.querySelectorAll('.form-error').forEach(error => {
        error.style.display = 'none';
    });
    
    // Check honeypot
    {% if config.honeypot_protection %}
    const honeypot = form.querySelector('input[name="honeypot"]');
    if (honeypot && honeypot.value !== '') {
        // Spam detected, silently fail
        return false;
    }
    {% endif %}
    
    // Disable submit button
    const submitButton = form.querySelector('.submit-button');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';
    
    // Prepare form data
    const formData = new FormData(form);
    
    // Submit via AJAX
    fetch(form.action || window.location.href, {
        method: form.method,
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('form-success').style.display = 'block';
            
            {% if config.redirect_url %}
                setTimeout(() => {
                    window.location.href = '{{ config.redirect_url }}';
                }, 2000);
            {% else %}
                form.reset();
            {% endif %}
        } else {
            if (data.errors) {
                // Display field errors
                Object.keys(data.errors).forEach(fieldName => {
                    const errorElement = document.getElementById('error_' + fieldName);
                    if (errorElement) {
                        errorElement.textContent = data.errors[fieldName];
                        errorElement.style.display = 'block';
                    }
                });
            } else {
                document.getElementById('form-error').style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Form submission error:', error);
        document.getElementById('form-error').style.display = 'block';
    })
    .finally(() => {
        // Re-enable submit button
        submitButton.disabled = false;
        submitButton.textContent = originalText;
    });
    
    return false;
}
</script>
{% endif %}
