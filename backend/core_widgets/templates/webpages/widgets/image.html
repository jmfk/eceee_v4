{% load static %}

<div class="image-widget size-{{ config.display_size|default:'medium' }}">
    {% if config.display_type == 'single' %}
        <!-- Single image/video display -->
        {% for item in config.media_items %}
            {% if forloop.first %}
                {% if item.type == 'video' %}
                    <video controls {% if config.auto_play %}autoplay{% endif %}>
                        <source src="{{ item.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% else %}
                    <img src="{{ item.url }}" alt="{{ item.alt_text }}" loading="lazy">
                {% endif %}
                
                {% if config.show_captions and item.caption %}
                    <div class="caption">{{ item.caption }}</div>
                {% endif %}
            {% endif %}
        {% endfor %}
        
    {% elif config.display_type == 'gallery' %}
        <!-- Gallery display -->
        <div class="gallery" style="--gallery-columns: {{ config.gallery_columns|default:3 }};">
            {% for item in config.media_items %}
                <div class="gallery-item" {% if config.enable_lightbox %}data-lightbox="gallery"{% endif %}>
                    {% if item.type == 'video' %}
                        <video {% if item.thumbnail %}poster="{{ item.thumbnail }}"{% endif %} 
                               {% if config.auto_play %}autoplay{% endif %} muted>
                            <source src="{{ item.url }}" type="video/mp4">
                        </video>
                    {% else %}
                        <img src="{{ item.url }}" alt="{{ item.alt_text }}" loading="lazy">
                    {% endif %}
                    
                    {% if config.show_captions and item.caption %}
                        <div class="caption">{{ item.caption }}</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
    {% elif config.display_type == 'carousel' %}
        <!-- Carousel display -->
        <div class="carousel" id="carousel-{{ widget.id }}">
            <div class="carousel-inner">
                {% for item in config.media_items %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        {% if item.type == 'video' %}
                            <video controls {% if config.auto_play %}autoplay{% endif %}>
                                <source src="{{ item.url }}" type="video/mp4">
                            </video>
                        {% else %}
                            <img src="{{ item.url }}" alt="{{ item.alt_text }}" loading="lazy">
                        {% endif %}
                        
                        {% if config.show_captions and item.caption %}
                            <div class="caption">{{ item.caption }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            {% if config.media_items|length > 1 %}
                <button class="carousel-prev" onclick="previousSlide('carousel-{{ widget.id }}')">&lt;</button>
                <button class="carousel-next" onclick="nextSlide('carousel-{{ widget.id }}')">&gt;</button>
                
                <div class="carousel-indicators">
                    {% for item in config.media_items %}
                        <button class="{% if forloop.first %}active{% endif %}" 
                                onclick="currentSlide('carousel-{{ widget.id }}', {{ forloop.counter0 }})"></button>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <script>
        function previousSlide(carouselId) {
            const carousel = document.getElementById(carouselId);
            const items = carousel.querySelectorAll('.carousel-item');
            const activeItem = carousel.querySelector('.carousel-item.active');
            const activeIndex = Array.from(items).indexOf(activeItem);
            const prevIndex = activeIndex === 0 ? items.length - 1 : activeIndex - 1;
            
            activeItem.classList.remove('active');
            items[prevIndex].classList.add('active');
            
            updateIndicators(carouselId, prevIndex);
        }
        
        function nextSlide(carouselId) {
            const carousel = document.getElementById(carouselId);
            const items = carousel.querySelectorAll('.carousel-item');
            const activeItem = carousel.querySelector('.carousel-item.active');
            const activeIndex = Array.from(items).indexOf(activeItem);
            const nextIndex = activeIndex === items.length - 1 ? 0 : activeIndex + 1;
            
            activeItem.classList.remove('active');
            items[nextIndex].classList.add('active');
            
            updateIndicators(carouselId, nextIndex);
        }
        
        function currentSlide(carouselId, index) {
            const carousel = document.getElementById(carouselId);
            const items = carousel.querySelectorAll('.carousel-item');
            const activeItem = carousel.querySelector('.carousel-item.active');
            
            activeItem.classList.remove('active');
            items[index].classList.add('active');
            
            updateIndicators(carouselId, index);
        }
        
        function updateIndicators(carouselId, activeIndex) {
            const carousel = document.getElementById(carouselId);
            const indicators = carousel.querySelectorAll('.carousel-indicators button');
            
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === activeIndex);
            });
        }
        </script>
    {% endif %}
</div>
