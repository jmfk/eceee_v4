{% load static %}
{% load security_filters %}

<aside class="sidebar-widget position-{{ config.position|default:'right' }} {% if config.collapsible %}collapsible{% endif %} {% if config.css_class %}{{ config.css_class }}{% endif %}"
       {% if config.background_color or config.background_image or config.text_color or config.padding or config.margin or config.width %}
           style="
               {% if config.background_color %}background-color: {{ config.background_color }};{% endif %}
               {% if config.background_image %}
                   background-image: url('{{ config.background_image }}');
                   background-size: {{ config.background_size|default:'cover' }};
                   background-position: {{ config.background_position|default:'center' }};
                   background-repeat: no-repeat;
               {% endif %}
               {% if config.text_color %}color: {{ config.text_color }};{% endif %}
               {% if config.padding %}padding: {{ config.padding }};{% endif %}
               {% if config.margin %}margin: {{ config.margin }};{% endif %}
               {% if config.width %}width: {{ config.width }};{% endif %}
               {% if config.text_align != 'left' %}text-align: {{ config.text_align }};{% endif %}
           "
       {% endif %}>
    
    {% if config.collapsible %}
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <span class="sidebar-toggle-icon">â˜°</span>
        </button>
    {% endif %}
    
    <div class="sidebar-content" id="sidebar-content">
        {% if config.widgets %}
            <!-- Render nested widgets -->
            {% for widget_section in config.widgets %}
                <div class="sidebar-section">
                    {% if widget_section.title %}
                        <h3 class="sidebar-section-title">{{ widget_section.title }}</h3>
                    {% endif %}
                    
                    {% if widget_section.content %}
                        <div class="sidebar-section-content">
                            {{ widget_section.content|sanitize_html }}
                        </div>
                    {% endif %}
                    
                    {% if widget_section.type == 'list' and widget_section.items %}
                        <div class="sidebar-widget-list">
                            <ul>
                                {% for item in widget_section.items %}
                                    <li>
                                        {% if item.url %}
                                            <a href="{{ item.url }}">{{ item.title }}</a>
                                        {% else %}
                                            {{ item.title }}
                                        {% endif %}
                                        {% if item.description %}
                                            <small>{{ item.description }}</small>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <!-- Fallback: render main content -->
            {{ config.content|sanitize_html }}
        {% endif %}
    </div>
    
    {% if config.custom_css %}
        <style>
            {{ config.custom_css|safe }}
        </style>
    {% endif %}
    
    {% if config.collapsible %}
        <script>
            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar-widget');
                const content = document.getElementById('sidebar-content');
                
                sidebar.classList.toggle('collapsed');
                
                if (sidebar.classList.contains('collapsed')) {
                    content.style.display = 'none';
                } else {
                    content.style.display = 'block';
                }
            }
            
            // Auto-collapse on mobile
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar-widget');
                if (sidebar && sidebar.classList.contains('collapsible')) {
                    sidebar.classList.add('collapsed');
                    document.getElementById('sidebar-content').style.display = 'none';
                }
            }
        </script>
    {% endif %}
</aside>
