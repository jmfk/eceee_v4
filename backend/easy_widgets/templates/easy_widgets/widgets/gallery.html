{% load static %}

<div class="widget-type-{{ widget_type.css_class_name }}" data-widget-type="gallery">
    {% if config.title %}
        <header class="gallery-header">
            <h2 class="gallery-title">{{ config.title }}</h2>
        </header>
    {% endif %}

    <div class="gallery-container" 
         data-layout="{{ config.layout|default:'grid' }}"
         data-columns="{{ config.columns|default:3 }}"
         data-show-captions="{{ config.show_captions|yesno:'true,false' }}"
         data-enable-lightbox="{{ config.enable_lightbox|yesno:'true,false' }}"
         data-auto-play="{{ config.auto_play|yesno:'true,false' }}">
         
        {% if config.layout == 'carousel' %}
            <div class="gallery-carousel" id="gallery-carousel">
                <div class="carousel-container">
                    <div class="carousel-track" id="carousel-track">
                        {% for image in config.images %}
                            <div class="carousel-slide" data-index="{{ forloop.counter0 }}">
                                {% if config.enable_lightbox %}
                                    <a data-lightbox
                                       data-lightbox-group="gallery-{{ widget.id }}"
                                       data-lightbox-src="{{ image.url }}"
                                       data-lightbox-caption="{{ image.caption|default:'' }}"
                                       data-lightbox-alt="{{ image.alt_text }}"
                                       href="{{ image.url }}"
                                       style="cursor: pointer;">
                                        <img src="{{ image.thumbnail|default:image.url }}" 
                                             alt="{{ image.alt_text }}"
                                             class="carousel-image"
                                             data-index="{{ forloop.counter0 }}">
                                    </a>
                                {% else %}
                                    <img src="{{ image.thumbnail|default:image.url }}" 
                                         alt="{{ image.alt_text }}"
                                         class="carousel-image"
                                         data-index="{{ forloop.counter0 }}">
                                {% endif %}
                                {% if config.show_captions and image.caption %}
                                    <div class="carousel-caption">{{ image.caption }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if config.images|length > 1 %}
                        <button class="carousel-btn carousel-prev" data-direction="-1">
                            <i class="icon-prev" aria-hidden="true"></i>
                        </button>
                        <button class="carousel-btn carousel-next" data-direction="1">
                            <i class="icon-next" aria-hidden="true"></i>
                        </button>
                        
                        <div class="carousel-indicators">
                            {% for image in config.images %}
                                <button class="indicator-dot {% if forloop.first %}active{% endif %}" 
                                        data-slide-index="{{ forloop.counter0 }}"></button>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
        {% else %}
            <!-- Grid, Masonry, or Lightbox layouts -->
            <div class="gallery-grid" 
                 style="grid-template-columns: repeat({{ config.columns|default:3 }}, 1fr); grid-auto-flow: dense;">
                {% for image in config.images %}
                    {% comment %}Calculate aspect ratio for grid spanning{% endcomment %}
                    {% if image.width and image.height %}
                        {% widthratio image.width image.height 100 as aspect_ratio_x100 %}
                        {% if aspect_ratio_x100 > 130 %}
                            {% comment %}Horizontal: aspect > 1.3{% endcomment %}
                            <div class="gallery-item" data-index="{{ forloop.counter0 }}" style="grid-column: span 2;">
                        {% elif aspect_ratio_x100 < 70 %}
                            {% comment %}Vertical: aspect < 0.7{% endcomment %}
                            <div class="gallery-item" data-index="{{ forloop.counter0 }}" style="grid-row: span 2;">
                        {% else %}
                            {% comment %}Square: 0.7 <= aspect <= 1.3{% endcomment %}
                            <div class="gallery-item" data-index="{{ forloop.counter0 }}">
                        {% endif %}
                    {% else %}
                        <div class="gallery-item" data-index="{{ forloop.counter0 }}">
                    {% endif %}
                        <div class="image-container">
                            {% if config.enable_lightbox %}
                                <a data-lightbox
                                   data-lightbox-group="gallery-{{ widget.id }}"
                                   data-lightbox-src="{{ image.url }}"
                                   data-lightbox-caption="{{ image.caption|default:'' }}"
                                   data-lightbox-alt="{{ image.alt_text }}"
                                   href="{{ image.url }}"
                                   style="cursor: pointer;">
                                    {% if image.width and image.height %}
                                        {% widthratio image.width image.height 100 as aspect_ratio_x100 %}
                                        {% if aspect_ratio_x100 > 130 or aspect_ratio_x100 < 70 %}
                                            <img src="{{ image.thumbnail|default:image.url }}" 
                                                 alt="{{ image.alt_text }}"
                                                 class="gallery-image"
                                                 style="object-fit: contain;"
                                                 loading="lazy">
                                        {% else %}
                                            <img src="{{ image.thumbnail|default:image.url }}" 
                                                 alt="{{ image.alt_text }}"
                                                 class="gallery-image"
                                                 style="object-fit: cover;"
                                                 loading="lazy">
                                        {% endif %}
                                    {% else %}
                                        <img src="{{ image.thumbnail|default:image.url }}" 
                                             alt="{{ image.alt_text }}"
                                             class="gallery-image"
                                             style="object-fit: cover;"
                                             loading="lazy">
                                    {% endif %}
                                    <div class="image-overlay">
                                        <i class="icon-expand" aria-hidden="true"></i>
                                    </div>
                                </a>
                            {% else %}
                                {% if image.width and image.height %}
                                    {% widthratio image.width image.height 100 as aspect_ratio_x100 %}
                                    {% if aspect_ratio_x100 > 130 or aspect_ratio_x100 < 70 %}
                                        <img src="{{ image.thumbnail|default:image.url }}" 
                                             alt="{{ image.alt_text }}"
                                             class="gallery-image"
                                             style="object-fit: contain;"
                                             loading="lazy">
                                    {% else %}
                                        <img src="{{ image.thumbnail|default:image.url }}" 
                                             alt="{{ image.alt_text }}"
                                             class="gallery-image"
                                             style="object-fit: cover;"
                                             loading="lazy">
                                    {% endif %}
                                {% else %}
                                    <img src="{{ image.thumbnail|default:image.url }}" 
                                         alt="{{ image.alt_text }}"
                                         class="gallery-image"
                                         style="object-fit: cover;"
                                         loading="lazy">
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        {% if config.show_captions and image.caption %}
                            <div class="image-caption">
                                <h4 class="caption-title">{{ image.caption }}</h4>
                                {% if image.description %}
                                    <p class="caption-description">{{ image.description }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

</div>

<script>
let currentSlide = 0;
let autoPlayInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    const galleryWidget = document.querySelector('.gallery-widget');
    const galleryContainer = galleryWidget?.querySelector('.gallery-container');
    
    if (!galleryContainer) return;
    
    const autoPlay = galleryContainer.dataset.autoPlay === 'true';
    const layout = galleryContainer.dataset.layout;
    
    // Initialize carousel auto-play if enabled
    if (autoPlay && layout === 'carousel') {
        const slides = document.querySelectorAll('.carousel-slide');
        if (slides.length > 1) {
            startAutoPlay();
        }
    }
    
    // Initialize masonry layout if needed
    if (layout === 'masonry') {
        initMasonryLayout();
    }
});

// Carousel functionality
function changeSlide(direction) {
    const track = document.getElementById('carousel-track');
    const slides = track?.querySelectorAll('.carousel-slide');
    if (!slides || slides.length === 0) return;
    
    const totalSlides = slides.length;
    currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
    updateCarousel();
    resetAutoPlay();
}

function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
    resetAutoPlay();
}

function updateCarousel() {
    const track = document.getElementById('carousel-track');
    const indicators = document.querySelectorAll('.indicator-dot');
    
    if (track) {
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
    }
    
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentSlide);
    });
}

function startAutoPlay() {
    const autoPlayDelay = 5000; // 5 seconds
    autoPlayInterval = setInterval(() => {
        changeSlide(1);
    }, autoPlayDelay);
}

function resetAutoPlay() {
    if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
    }
}

// Masonry layout (basic implementation)
function initMasonryLayout() {
    const grid = document.querySelector('.gallery-grid');
    if (!grid) return;
    
    // This is a simplified masonry layout
    // For production, consider using a library like Masonry.js
    grid.style.display = 'columns';
    grid.style.columnGap = '1rem';
}
</script>

<!-- 
    Gallery/Carousel/Lightbox CSS now loaded dynamically from theme
    See /api/webpages/themes/{theme_id}/styles.css
    
    All widget styling has been moved to the theme system for:
    - Better performance (cached and served separately)
    - Easier customization (edit in theme editor)
    - Centralized management (all CSS in one place)
--> 