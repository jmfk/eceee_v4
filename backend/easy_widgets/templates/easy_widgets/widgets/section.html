{% load static %}
{% load security_filters %}

{% comment %}
Section Widget Template
- Only renders if content exists (checked in render() method)
- If enable_collapse: shows header + collapsible content
- If NOT enable_collapse: shows content only (no wrapper, no header)
- Accordion mode: only one section open at a time (except initial state)
{% endcomment %}

{% if config.enable_collapse %}
    {# Collapsible section with header #}
    <div class="section-widget{% if config.show_border %} border-enabled{% endif %}" 
         {% if config.anchor %}id="{{ config.anchor }}"{% endif %}
         data-section-id="{{ config.anchor|default:'' }}"
         {% if config.accordion_mode %}data-accordion-mode="true"{% endif %}>
        
        {% if config.title %}
        <div class="section-header" 
             onclick="toggleSection(this)"
             data-expanded="{{ config.start_expanded|default:true|yesno:'true,false' }}">
            <span class="section-title">{{ config.title }}</span>
            <span class="section-toggle {% if config.start_expanded %}expanded{% endif %}">â–¶</span>
        </div>
        {% endif %}
        
        <div class="section-content {% if config.start_expanded %}expanded{% else %}collapsed{% endif %}"
             style="max-height: {% if config.start_expanded %}5000px{% else %}0{% endif %};">
            {% for widget in config.rendered_slots.content %}
                <div class="widget-wrapper">
                    {{ widget.html|sanitize_html }}
                </div>
            {% endfor %}
        </div>
    </div>
{% else %}
    {# Non-collapsible: just render content directly with anchor #}
    <div {% if config.anchor %}id="{{ config.anchor }}"{% endif %} class="section-content-only{% if config.show_border %} border-enabled{% endif %}">
        {% for widget in config.rendered_slots.content %}
            <div class="widget-wrapper">
                {{ widget.html|sanitize_html }}
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if config.enable_collapse %}
<script>
(function() {
    // Toggle section collapse/expand
    window.toggleSection = function(headerElement) {
        const sectionWidget = headerElement.closest('.section-widget');
        const contentElement = sectionWidget.querySelector('.section-content');
        const toggleIcon = headerElement.querySelector('.section-toggle');
        const isExpanded = contentElement.classList.contains('expanded');
        
        // Handle accordion mode
        if (sectionWidget.dataset.accordionMode === 'true') {
            // Close all other sections with accordion mode
            const allSections = document.querySelectorAll('.section-widget[data-accordion-mode="true"]');
            allSections.forEach(section => {
                if (section !== sectionWidget) {
                    const otherContent = section.querySelector('.section-content');
                    const otherToggle = section.querySelector('.section-toggle');
                    if (otherContent && otherContent.classList.contains('expanded')) {
                        otherContent.classList.remove('expanded');
                        otherContent.classList.add('collapsed');
                        otherContent.style.maxHeight = '0';
                        if (otherToggle) {
                            otherToggle.classList.remove('expanded');
                        }
                    }
                }
            });
        }
        
        // Toggle current section
        if (isExpanded) {
            // Collapse
            contentElement.classList.remove('expanded');
            contentElement.classList.add('collapsed');
            contentElement.style.maxHeight = '0';
            if (toggleIcon) {
                toggleIcon.classList.remove('expanded');
            }
        } else {
            // Expand
            contentElement.classList.remove('collapsed');
            contentElement.classList.add('expanded');
            contentElement.style.maxHeight = contentElement.scrollHeight + 'px';
            if (toggleIcon) {
                toggleIcon.classList.add('expanded');
            }
        }
    };
    
    // Initialize sections on load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.section-content.expanded').forEach(function(content) {
            if (content.closest('.section-widget').querySelector('.section-header[data-expanded]')) {
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        });
    });
})();
</script>
{% endif %}
