{% load static %}
{% load security_filters %}

{% comment %}
Section Widget Template
- Only renders if content exists (checked in render() method)
- If enable_collapse: shows header + collapsible content
- If NOT enable_collapse: shows content only (no wrapper, no header)
- Accordion mode: only one section open at a time (except initial state)
{% endcomment %}

{% if config.enable_collapse %}
    {# Collapsible section with header #}
    <div class="section-widget{% if config.show_border %} border-enabled{% endif %} {% if not config.start_expanded %}section-collapsed{% endif %}" 
         {% if config.anchor %}id="{{ config.anchor }}"{% endif %}
         data-section-id="{{ config.anchor|default:'' }}"
         {% if config.accordion_mode %}data-accordion-mode="true"{% endif %}>
        
        {% if config.title %}
        <div class="section-header">
            <span class="section-title">{{ config.title }}</span>
        </div>
        {% endif %}
        
        <div class="section-content">
            {# First widget - always visible #}
            {% if config.rendered_slots.content %}
                {{ config.rendered_slots.content.0.html|safe }}
            {% endif %}
            
            {# Remaining widgets - hidden when collapsed #}
            <div class="section-remaining-content">
                {% for widget in config.rendered_slots.content %}
                    {% if not forloop.first %}
                        {{ widget.html|safe }}
                    {% endif %}
                {% endfor %}
            </div>
            
            {# Expand/Contract banners #}
            <div class="section-banner expand-banner" 
                 onclick="toggleSection(this)"
                 style="background-color: {{ config.banner_bg_color|default:'#f3f4f6' }}; color: {{ config.banner_text_color|default:'#374151' }};">
                <span>{{ config.expand_text|default:'Expand to read more' }}</span>
            </div>
            <div class="section-banner contract-banner" 
                 onclick="toggleSection(this)"
                 style="background-color: {{ config.banner_bg_color|default:'#f3f4f6' }}; color: {{ config.banner_text_color|default:'#374151' }};">
                <span>{{ config.contract_text|default:'Show less' }}</span>
            </div>
        </div>
    </div>
{% else %}
    {# Non-collapsible: just render content directly with anchor #}
    <div {% if config.anchor %}id="{{ config.anchor }}"{% endif %} class="section-content-only{% if config.show_border %} border-enabled{% endif %}">
        {% for widget in config.rendered_slots.content %}
            {{ widget.html|safe }}
        {% endfor %}
    </div>
{% endif %}

{% if config.enable_collapse %}
<script>
(function() {
    window.toggleSection = function(element) {
        const sectionWidget = element.closest('.section-widget');
        const isCollapsed = sectionWidget.classList.contains('section-collapsed');
        
        // Handle accordion mode
        if (sectionWidget.dataset.accordionMode === 'true') {
            const allSections = document.querySelectorAll('.section-widget[data-accordion-mode="true"]');
            allSections.forEach(section => {
                if (section !== sectionWidget && !section.classList.contains('section-collapsed')) {
                    section.classList.add('section-collapsed');
                }
            });
        }
        
        // Toggle current section
        if (isCollapsed) {
            sectionWidget.classList.remove('section-collapsed');
        } else {
            sectionWidget.classList.add('section-collapsed');
        }
    };
})();
</script>
{% endif %}
