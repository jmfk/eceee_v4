{% if config.display_type == 'gallery' and config.media_items %}
    <!-- Gallery Display -->
    <div class="widget-type-image widget-type-gallery" data-widget-type="gallery">
        <div class="gallery-container" 
             data-columns="{{ config.gallery_columns|default:3 }}"
             data-show-captions="{{ config.show_captions|yesno:'true,false' }}"
             data-enable-lightbox="{{ config.enable_lightbox|yesno:'true,false' }}">
            
            <div class="gallery-grid" 
                 style="grid-template-columns: repeat({{ config.gallery_columns|default:3 }}, 1fr);">
                {% for item in config.media_items %}
                    <div class="gallery-item" data-index="{{ forloop.counter0 }}">
                        <div class="image-container">
                            {% if item.type == 'video' %}
                                <video 
                                    src="{{ item.url }}" 
                                    class="gallery-image"
                                    {% if config.auto_play %}autoplay loop muted{% endif %}
                                    loading="lazy">
                                </video>
                            {% else %}
                                <a 
                                    {% if config.enable_lightbox %}
                                        data-lightbox
                                        data-lightbox-group="{{ config.lightbox_group|default:'widget-'|add:widget.id }}"
                                        data-lightbox-src="{{ item.url }}"
                                        data-lightbox-caption="{{ item.caption|default:'' }}"
                                        data-lightbox-alt="{{ item.alt_text|default:'' }}"
                                        data-lightbox-style="{{ config.lightbox_style|default:config.image_style|default:'default' }}"
                                    {% endif %}
                                >
                                    <img 
                                        src="{{ item.thumbnail_url|default:item.url }}" 
                                        {% if item.srcset %}srcset="{{ item.srcset }}"{% endif %}
                                        {% if item.display_width %}width="{{ item.display_width }}"{% endif %}
                                        {% if item.display_height %}height="{{ item.display_height }}"{% endif %}
                                        alt="{{ item.alt_text }}"
                                        class="gallery-image"
                                        loading="lazy"
                                        {% if config.enable_lightbox %}
                                            style="cursor: pointer;"
                                        {% endif %}
                                    >
                                </a>
                            {% endif %}
                            
                            {% if config.enable_lightbox %}
                                <div class="image-overlay">
                                    <span class="expand-icon">üîç</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if config.show_captions and item.caption %}
                            <div class="image-caption">
                                {{ item.caption }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        {% comment %} Global lightbox is handled system-wide via HTMX + Alpine {% endcomment %}
    </div>

{% elif config.display_type == 'carousel' and config.media_items %}
    <!-- Carousel Display -->
    <div class="widget-type-image widget-type-carousel" data-widget-type="carousel">
        <div class="carousel-container">
            <div class="carousel-track" id="carousel-track-{{ widget.id }}">
                {% for item in config.media_items %}
                    <div class="carousel-slide" data-index="{{ forloop.counter0 }}">
                        {% if item.type == 'video' %}
                            <video 
                                src="{{ item.url }}" 
                                class="carousel-image"
                                {% if config.auto_play %}autoplay loop muted{% endif %}>
                            </video>
                        {% else %}
                            <a 
                                {% if config.enable_lightbox %}
                                    data-lightbox
                                    data-lightbox-group="{{ config.lightbox_group|default:'widget-'|add:widget.id }}"
                                    data-lightbox-src="{{ item.url }}"
                                    data-lightbox-caption="{{ item.caption|default:'' }}"
                                    data-lightbox-alt="{{ item.alt_text|default:'' }}"
                                    data-lightbox-style="{{ config.lightbox_style|default:config.image_style|default:'default' }}"
                                {% endif %}
                            >
                                <img 
                                    src="{{ item.thumbnail_url|default:item.url }}" 
                                    {% if item.srcset %}srcset="{{ item.srcset }}"{% endif %}
                                    {% if item.display_width %}width="{{ item.display_width }}"{% endif %}
                                    {% if item.display_height %}height="{{ item.display_height }}"{% endif %}
                                    alt="{{ item.alt_text }}"
                                    class="carousel-image">
                            </a>
                        {% endif %}
                        {% if config.show_captions and item.caption %}
                            <div class="carousel-caption">{{ item.caption }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            {% if config.media_items|length > 1 %}
                <button class="carousel-btn carousel-prev" onclick="changeSlide{{ widget.id }}(-1)">‚óÄ</button>
                <button class="carousel-btn carousel-next" onclick="changeSlide{{ widget.id }}(1)">‚ñ∂</button>
                
                <div class="carousel-indicators">
                    {% for item in config.media_items %}
                        <button class="indicator-dot {% if forloop.first %}active{% endif %}" 
                                onclick="goToSlide{{ widget.id }}({{ forloop.counter0 }})"></button>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <script>
        (function() {
            let currentSlide = 0;

            window.changeSlide{{ widget.id }} = function(direction) {
                const track = document.getElementById('carousel-track-{{ widget.id }}');
                const slides = track.querySelectorAll('.carousel-slide');
                const totalSlides = slides.length;
                
                currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
                updateCarousel{{ widget.id }}();
            };

            window.goToSlide{{ widget.id }} = function(index) {
                currentSlide = index;
                updateCarousel{{ widget.id }}();
            };

            function updateCarousel{{ widget.id }}() {
                const track = document.getElementById('carousel-track-{{ widget.id }}');
                const container = track.closest('.carousel-widget');
                const indicators = container.querySelectorAll('.indicator-dot');
                
                if (track) {
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }
                
                indicators.forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === currentSlide);
                });
            }

            {% if config.auto_play %}
            // Auto-play functionality
            setInterval(function() {
                changeSlide{{ widget.id }}(1);
            }, {{ config.auto_play_interval|default:3 }} * 1000);
            {% endif %}
        })();
        </script>
    </div>

{% else %}
    <!-- Single Image Display -->
    <div class="widget-type-image image-size-{{ config.size|default:'medium' }} image-align-{{ config.alignment|default:'center' }}">
        {% if config.media_items and config.media_items|length > 0 %}
            {% with item=config.media_items.0 %}
                <div class="image-container">
                    {% if item.type == 'video' %}
                        <video 
                            src="{{ item.url }}" 
                            class="widget-image"
                            {% if config.auto_play %}autoplay loop muted{% endif %}
                            loading="lazy">
                        </video>
                    {% else %}
                        <a 
                            {% if config.enable_lightbox %}
                                data-lightbox
                                data-lightbox-group="{{ config.lightbox_group|default:'widget-'|add:widget.id }}"
                                data-lightbox-src="{{ item.url }}"
                                data-lightbox-caption="{{ item.caption|default:'' }}"
                                data-lightbox-alt="{{ item.alt_text|default:'' }}"
                                data-lightbox-style="{{ config.lightbox_style|default:config.image_style|default:'default' }}"
                            {% endif %}
                        >
                            <img 
                                src="{{ item.url }}" 
                                {% if item.srcset %}srcset="{{ item.srcset }}"{% endif %}
                                {% if item.display_width %}width="{{ item.display_width }}"{% endif %}
                                {% if item.display_height %}height="{{ item.display_height }}"{% endif %}
                                alt="{{ item.alt_text }}"
                                class="widget-image"
                                loading="lazy"
                            />
                        </a>
                    {% endif %}
                </div>
                
                {% if config.show_captions and item.caption %}
                    <div class="image-caption">
                        {{ item.caption }}
                    </div>
                {% endif %}
            {% endwith %}
        {% elif config.image_url %}
            <div class="image-container">
                <img 
                    src="{{ config.image_url }}" 
                    alt="{{ config.alt_text }}"
                    class="widget-image"
                    loading="lazy"
                />
            </div>
            
            {% if config.caption %}
                <div class="image-caption">
                    {{ config.caption }}
                </div>
            {% endif %}
{% endif %}
</div>
{% endif %}

<!-- 
    Image/Gallery/Carousel/Lightbox CSS now loaded dynamically from theme
    See /api/webpages/themes/{theme_id}/styles.css
    
    All widget styling has been moved to the theme system for:
    - Better performance (cached and served separately)
    - Easier customization (edit in theme editor)
    - Centralized management (all CSS in one place)
-->